<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>GPS 显示测试</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    <h2>当前位置：</h2>
    <p id="position">加载中...</p>

    <script>
        // OneNET API 参数
        const url = "https://iot-api.heclouds.com/datapoint/history-datapoints";
        const query = {
            product_id: "dyLIMxujKq",
            device_name: "nbiot",
            datastream_id: "GPS",
            limit: 1
        };
        const headers = {
            "Accept": "application/json, text/plain, */*",
            "Authorization": "version=2022-05-01&res=userid%2F464993&et=1758508478&method=sha1&sign=uVq%2FUSFNtfKq9yth7RNVLNICUD8%3D"
        };

        function fetchGPS() {
            const queryString = Object.keys(query)
                .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(query[k]))
                .join('&');

            fetch(url + "?" + queryString, { headers })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 0 && data.data.datastreams.length > 0) {
                        const gpsStream = data.data.datastreams.find(ds => ds.id === "GPS");
                        if (gpsStream && gpsStream.datapoints.length > 0) {
                            const gps = gpsStream.datapoints[0].value;
                            document.getElementById("position").innerText = "纬度: " + gps.lat + ", 经度: " + gps.lon;
                        } else {
                            document.getElementById("position").innerText = "没有 GPS 数据";
                        }
                    } else {
                        document.getElementById("position").innerText = "请求失败";
                        console.log(data);
                    }
                })
                .catch(err => {
                    document.getElementById("position").innerText = "请求异常";
                    console.error(err);
                });
        }

        // 页面加载后立即获取 GPS
        fetchGPS();
        // 每 5 秒刷新一次
        setInterval(fetchGPS, 5000);
    </script>
</body>
</html>
